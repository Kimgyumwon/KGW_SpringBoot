<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
    <mapper namespace="com.kgw.app.users.UsersDAO">
    	<!-- 회원가입 -->
    	<insert id="register" parameterType="UsersDTO" useGeneratedKeys="true" keyProperty="username">
    		INSERT INTO users (username, password, name, email, phone, birth)
			VALUES ( #{username}, #{password}, #{name}, #{email}, #{phone}, #{birth} )
    	</insert>
    	
    	<select id="login" parameterType="UsersDTO" resultType="UsersDTO">
    		SELECT * FROM users
    		WHERE username=#{username} AND password=#{password}
    	</select>
    	
    	
    	<select id="detail" resultMap="detailResult" resultType="UsersDTO">
			select * from users u
				left join user_role ur
				on u.username = ur.username
				left join role r
				on ur.role_num = r.role_num
				left join profile p
				on p.username = u.username
			where u.username = #{username}
    	</select>
    	
    	<resultMap type="UsersDTO" id="detailResult">
    		<id column="username" property="username"/>
    		<result column="password" property="password"/>
    		<result column="name" property="name"/>
    		<result column="email" property="email"/>
    		<result column="phone" property="phone"/>
    		<result column="birth" property="birth"/>
    		<result column="account_non_expired" property="accountNonExpired"/>
    		<result column="account_non_locked" property="accountNonLocked"/>
    		<result column="credentials_non_expired" property="credentialsNonExpired"/>
    		<result column="enabled" property="enabled"/>
    		
    		<association property="usersFileDTO" javaType="UsersFileDTO">
    			<id column="file_num" property="fileNum"/>
    			<result column="file_name" property="fileName"/>
    			<result column="file_origin" property="fileOrigin"/>
    		</association>
    		<collection property="roleDTOs" javaType="java.util.List" ofType="RoleDTO">
    			<id column="role_num" property="roleNum"/>
    			<result column="role_name" property="roleName"/>
    		</collection>
    	</resultMap>
    	
    	
    	<insert id="roleAdd" parameterType="UsersDTO">
    		INSERT INTO user_role (username, role_num)
    		VALUES (#{username} , 3)
    	</insert>
    	
    	
    	
    	<!-- 프로필 사진 업로드 -->
   		<insert id="userFileAdd" parameterType="UsersFileDTO">
    		INSERT INTO profile (file_name, file_origin, username)
    		VALUES (#{fileName}, #{fileOrigin}, #{username})
    	</insert>
    	
    	<update id="update" parameterType="UsersDTO">
    		UPDATE users
    		<set>
    			name=#{name},
				<if test="email != null">
					email=#{email},
				</if>    			
				<if test="phone != null">
					phone=#{phone},
				</if>    
				<if test="birth != null">
					birth=#{birth},
				</if>    
    		</set>
			WHERE username=#{username}
    	</update>
    </mapper>